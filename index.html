<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>العوامل والمضاعفات</title>
    <link rel="manifest" href="manifest.json">
    <style>
        /* General Styles & Root Variables */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --bg-color: #ecf0f1;
            --text-color: #34495e;
            --tab-bg: #bdc3c7;
            --tab-active-bg: #fff;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --border-color: #ccc;
            --line-color: #999;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Tahoma', sans-serif;
        }

        body {
            direction: rtl;
            background-color: #F0F8FF; /* لون الماسي الفضي الذهبي */
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            width: 95%;
            max-width: 900px;
            margin: 20px auto;
            background: var(--tab-active-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            flex-grow: 1;
            padding: 10px;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            background: var(--primary-color);
            color: #fff;
        }

        .header h1 {
            font-size: clamp(24px, 6vw, 32px);
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--primary-color);
        }

        .tab-button {
            flex: 1;
            text-align: center;
            padding: 15px 10px;
            cursor: pointer;
            font-size: clamp(14px, 3.5vw, 18px);
            font-weight: bold;
            color: var(--primary-color);
            background-color: var(--tab-bg);
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab-button.active {
            background-color: var(--tab-active-bg);
            color: var(--secondary-color);
            border-bottom: 2px solid var(--secondary-color);
        }

        .tab-content {
            padding: 20px;
            display: none;
            flex-direction: column;
            gap: 20px;
            animation: fadeIn 0.5s ease-in-out;
        }

        .tab-content.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .input-group, .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .input-group input, .controls input {
            width: 100%;
            max-width: 250px;
            padding: 10px;
            font-size: 16px;
            border: 1px solid var(--tab-bg);
            border-radius: 8px;
            text-align: center;
        }
        
        .input-group button, .controls button {
            width: 100%;
            max-width: 250px;
            padding: 12px;
            font-size: 18px;
            background-color: var(--secondary-color);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .input-group button:hover, .controls button:hover {
            background-color: #2980b9;
        }
        
        .result-box, .solution-box {
            background-color: var(--bg-color);
            padding: 15px;
            border-radius: 8px;
            border: 1px dashed var(--secondary-color);
        }

        .solution-box {
            border-color: var(--accent-color);
            margin-top: 10px;
        }
        
        .solution-box h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--accent-color);
        }
        
        .solution-box ol, .solution-box ul {
            list-style-position: inside;
            padding-right: 20px;
        }
        
        .solution-box li {
            margin-bottom: 5px;
            line-height: 1.5;
        }

        .result-box p {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .result-list {
            list-style: none;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            direction: ltr;
        }
        
        .result-list.rtl {
            direction: rtl;
        }

        .result-item {
            background-color: var(--secondary-color);
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: normal;
        }
        
        /* New CSS for factors highlighting */
        .factor-item {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            background-color: #fff;
            border: 1px solid var(--tab-bg);
            border-radius: 4px;
            color: var(--text-color);
        }

        .common-factor-box {
            border: 2px solid var(--accent-color);
            border-radius: 4px;
            animation: pulse-box 1.5s infinite;
        }

        @keyframes pulse-box {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .prime-factor {
            display: inline-block;
            font-weight: bold;
            padding: 4px;
            margin: 0 2px;
            min-width: 25px;
            text-align: center;
            border-radius: 4px;
            color: var(--text-color);
        }

        .common-factor {
            border: 2px solid var(--accent-color);
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(231, 76, 60, 0.5);
            animation: pulse 1.5s infinite;
        }

        .uncommon-factor {
            border: 2px solid var(--secondary-color);
            border-radius: 50%;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Styles for Page 2: Factor Tree */
        .tree-container {
            position: relative;
            display: inline-block;
            margin-top: 10px;
            min-height: 200px; /* Prevents layout shift */
            width: 100%;
        }

        .svg-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .level {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 15px 0;
            position: relative;
            flex-wrap: wrap;
        }

        .node {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--control-bg);
            border: 2px solid var(--text-color);
            font-weight: bold;
            position: relative;
            transition: transform 0.3s ease, background-color 0.3s ease;
            white-space: nowrap;
            padding: 8px 12px;
        }

        .box {
            border-radius: 8px;
        }

        .circle {
            border-radius: 50%;
            color: white;
            min-width: 40px;
            min-height: 40px;
        }

        .node-prime {
            animation: pulse 1.5s infinite;
        }

        #result-display {
            font-size: 18px;
            margin-top: 20px;
            color: #555;
            line-height: 1.8;
            direction: ltr;
        }

        .result-line {
            font-size: clamp(16px, 4vw, 22px);
            font-weight: bold;
            margin: 5px 0;
        }

        .circle-inline {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            color: #fff;
            font-weight: bold;
            text-align: center;
            margin: 0 4px;
        }
        
        /* Styles for Page 3: Prime Numbers */
        #prime-numbers-tab h2 {font-weight:bold; font-size:22px; margin-bottom:10px; background:#000; color:#fff; padding:10px; border-radius:8px; display:inline-block;}
        #prime-numbers-tab label {font-weight:bold; font-size:18px; display:block; margin:10px 0 5px; background:#ccc; color:#9370DB; border-radius:6px; padding:6px;}
        #prime-numbers-tab input[type=number] {width:80px; padding:5px; margin:5px; font-size:16px; font-weight:bold;}
        #prime-numbers-tab button {padding:8px 16px; margin:5px; font-size:16px; font-weight:bold; cursor:pointer; background-color: #4B0082; color: white; border: none; border-radius: 6px;}
        #prime-numbers-tab .primes-grid {display:grid; grid-template-columns:repeat(5,1fr); gap:10px; justify-items:center; margin-top:10px; direction:ltr;}
        #prime-numbers-tab .prime {padding:6px 10px; border-radius:4px; display:inline-block; color:white; font-size:16px; min-width:40px; font-weight:bold;}
        #prime-numbers-tab #primesBox, #prime-numbers-tab #primeAtBox, #prime-numbers-tab #checkBox, #prime-numbers-tab #surroundingBox, #prime-numbers-tab #rankBox {margin-top:10px; padding:10px; background-color:#e6e6fa; border: 2px solid #9370DB; border-radius:8px; word-wrap:break-word; font-size:18px; font-weight:bold; min-height:50px; direction:rtl; display:block;}
        #prime-numbers-tab #factorsBox-prime {direction:ltr; display:inline-block; background:#ccc; color:#9370DB; border-radius:6px; font-weight:bold; margin-top:10px; font-size:18px; padding:4px 8px; white-space:nowrap;}
        #prime-numbers-tab #factorsBox-prime .prime {padding:2px 4px; border-radius:4px; display:inline-flex; color:white; font-size:16px; font-weight:bold; min-width:unset;}

        footer {
            text-align: center;
            padding: 15px;
            background: var(--primary-color);
            color: #fff;
            margin-top: 20px;
        }
        
        @media (max-width: 600px) {
            .tabs {
                flex-wrap: wrap;
            }
            .tab-button {
                flex: 50%;
                border-bottom: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🔢 العوامل والمضاعفات</h1>
    </div>

    <div class="container">
        <div class="tabs">
            <div class="tab-button active" onclick="showTab('factors-multiples-tab')">العوامل والمضاعفات</div>
            <div class="tab-button" onclick="showTab('factor-tree-tab')">شجرة العوامل</div>
            <div class="tab-button" onclick="showTab('prime-numbers-tab')">الأعداد الأولية</div>
        </div>

        <div id="factors-multiples-tab" class="tab-content active">
            <h2>🌿 العوامل والمضاعفات</h2>
            <div class="input-group">
                <input type="number" id="num1-factors" placeholder="أدخل العدد الأول" min="1">
                <input type="number" id="num2-factors" placeholder="أدخل العدد الثاني" min="1">
                <button onclick="calculateFactors()">احسب العوامل المشتركة</button>
            </div>
            <div id="result-factors" class="result-box" style="display: none;">
                <p>العوامل المشتركة:</p>
                <ul id="factors-list" class="result-list"></ul>
            </div>
            <div id="solution-factors" class="solution-box" style="display: none;"></div>
            <hr>
            <div class="input-group">
                <input type="number" id="num1-gcf" placeholder="أدخل العدد الأول" min="1">
                <input type="number" id="num2-gcf" placeholder="أدخل العدد الثاني" min="1">
                <button onclick="calculateGCF()">احسب العامل المشترك الأعلى</button>
            </div>
            <div id="result-gcf" class="result-box" style="display: none;">
                <p>العامل المشترك الأعلى (ع.م.أ):</p>
                <div id="gcf-value" class="result-list"></div>
            </div>
            <div id="solution-gcf" class="solution-box" style="display: none;"></div>
            <hr>
            <div class="input-group">
                <input type="number" id="num1-multiples" placeholder="أدخل العدد الأول" min="1">
                <input type="number" id="num2-multiples" placeholder="أدخل العدد الثاني" min="1">
                <button onclick="calculateMultiples()">احسب المضاعفات المشتركة</button>
            </div>
            <div id="result-multiples" class="result-box" style="display: none;">
                <p>أول 10 مضاعفات مشتركة:</p>
                <ul id="multiples-list" class="result-list"></ul>
            </div>
            <div id="solution-multiples" class="solution-box" style="display: none;"></div>
            <hr>
            <div class="input-group">
                <input type="number" id="num1-lcm" placeholder="أدخل العدد الأول" min="1">
                <input type="number" id="num2-lcm" placeholder="أدخل العدد الثاني" min="1">
                <button onclick="calculateLCM()">احسب المضاعف المشترك الأصغر</button>
            </div>
            <div id="result-lcm" class="result-box" style="display: none;">
                <p>المضاعف المشترك الأصغر (م.م.أ):</p>
                <div id="lcm-value" class="result-list"></div>
            </div>
            <div id="solution-lcm" class="solution-box" style="display: none;"></div>
        </div>

        <div id="factor-tree-tab" class="tab-content">
            <h2 style="color: var(--primary-color);">🌿 شجرة العوامل</h2>
            <div class="controls">
                <input type="number" id="numberInput" placeholder="أدخل عددًا" min="2" />
                <button onclick="saveAsImage()">📷 حفظ كصورة</button>
                <button onclick="generateAndShowTree()">عرض النتيجة</button>
            </div>
            <div class="tree-container" id="treeContainer">
                <svg class="svg-lines" id="svgLines"></svg>
                <div id="generatedTree"></div>
            </div>
            <div id="result-display"></div>
        </div>

        <div id="prime-numbers-tab" class="tab-content">
            <h2>🧮 توليد وتحليل الأعداد الأولية</h2>
            <div>
              <label>أدخل رقم n لإيجاد كل الأعداد الأولية الأصغر منه:</label>
              <input type="number" id="n-prime" value="100">
              <button onclick="gP()">اعرض الأعداد الأولية</button>
              <div id="primesBox-prime" class="primes-grid"></div>
            </div>
            <hr>
            <div>
              <label>أدخل ترتيب k لإيجاد العدد الأولي في هذا الترتيب:</label>
              <input type="number" id="k-prime" value="10">
              <button onclick="gPA()">اعرض العدد الأولي</button>
              <div id="primeAtBox-prime"></div>
            </div>
            <hr>
            <div>
              <label>اختبر إذا كان عدد m أوليًا:</label>
              <input type="number" id="m-prime" value="37">
              <button onclick="cP()">اختبر</button>
              <div id="checkBox-prime"></div>
            </div>
            <hr>
            <div>
              <label>أدخل عددا لإيجاد العددين الأوليين الأقرب المحصور بينهما:</label>
              <input type="number" id="x-prime" value="50">
              <button onclick="fSP()">اعرض العددين</button>
              <div id="surroundingBox-prime"></div>
            </div>
            <hr>
            <div>
              <label>أدخل عددا  لإيجاد رتبته إذا كان أوليًا، أو العددين الأوليين الأقرب ورتبتهما:</label>
              <input type="number" id="y-prime" value="20">
              <button onclick="fR()">اعرض الرتبة</button>
              <div id="rankBox-prime"></div>
            </div>
            <hr>
            <div>
              <label>أدخل عددا لتحليله إلى عوامله الأولية:</label>
              <input type="number" id="z-prime" value="120">
              <button onclick="fZ()">حلل</button>
              <div id="factorsBox-prime" class="result-box"></div>
            </div>
        </div>
    </div>

    <footer>
        <marquee direction="right">
            محمود عادل صالح - معلم رياضيات
            <a href="https://www.facebook.com/share/1CUGAQAAh4/" target="_blank">
                <img class="fb-icon" src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" alt="Facebook" style="width: 18px; height: 18px; vertical-align: middle; margin: 0 4px;">
            </a>
        </marquee>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
    <script>
        // Service Worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js').then(() => {
                console.log("Service Worker Registered");
            });
        }
        
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          deferredPrompt = e;
          const installBtn = document.createElement('button');
          installBtn.innerText = '📲 تثبيت التطبيق';
          installBtn.style.cssText = 'margin-top:10px; padding:8px 16px; font-size:16px;';
          document.body.appendChild(installBtn);
          installBtn.addEventListener('click', () => {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
              if (choiceResult.outcome === 'accepted') {
                console.log('User accepted the install prompt');
              } else {
                console.log('User dismissed the install prompt');
              }
              deferredPrompt = null;
            });
          });
        });

        // --- Tabs Logic ---
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.getElementById(tabId).style.display = 'flex';
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            showTab('factors-multiples-tab');
        });

        // --- All Functions from Page 1 (Factors and Multiples) ---
        function getFactors(num) {
            const factors = new Set();
            for (let i = 1; i <= Math.sqrt(num); i++) {
                if (num % i === 0) {
                    factors.add(i);
                    factors.add(num / i);
                }
            }
            return [...factors].sort((a, b) => a - b);
        }

        function getPrimeFactorsArray(num) {
            let n = num;
            const factors = [];
            for (let i = 2; i * i <= n; i++) {
                while (n % i === 0) {
                    factors.push(i);
                    n /= i;
                }
            }
            if (n > 1) {
                factors.push(n);
            }
            return factors;
        }

        function formatFactorsWithHighlight(factors, commonFactors) {
            return factors.map(f => {
                if (commonFactors.includes(f)) {
                    return `<span class="factor-item common-factor-box">${f}</span>`;
                }
                return `<span class="factor-item">${f}</span>`;
            }).join('');
        }

        function formatPrimeFactorsWithHighlight(factors1, factors2) {
            const factors1Copy = [...factors1];
            const factors2Copy = [...factors2];
            
            const result1 = [];
            const result2 = [];
            const commonFactors = [];
            const uncommonFactors = [];

            const commonSet = new Set();
            for(let f of factors1) {
                const indexIn2 = factors2Copy.indexOf(f);
                if (indexIn2 > -1) {
                    commonSet.add(f);
                    factors2Copy.splice(indexIn2, 1);
                }
            }
            
            factors1.forEach(f => {
                const indexIn2 = factors2.indexOf(f);
                if (commonSet.has(f) && indexIn2 > -1) {
                    result1.push(`<span class="prime-factor common-factor">${f}</span>`);
                    result2.push(`<span class="prime-factor common-factor">${f}</span>`);
                    commonFactors.push(f);
                    factors2.splice(indexIn2, 1);
                    commonSet.delete(f);
                } else {
                    result1.push(`<span class="prime-factor uncommon-factor">${f}</span>`);
                    uncommonFactors.push(f);
                }
            });

            factors2.forEach(f => {
                result2.push(`<span class="prime-factor uncommon-factor">${f}</span>`);
                uncommonFactors.push(f);
            });
            
            return {
                html1: result1.join(' × '),
                html2: result2.join(' × '),
                commonFactors,
                uncommonFactors
            };
        }
        
        function calculateFactors() {
            const num1 = parseInt(document.getElementById('num1-factors').value);
            const num2 = parseInt(document.getElementById('num2-factors').value);
            if (!num1 || !num2 || num1 < 1 || num2 < 1) {
                alert("الرجاء إدخال أعداد صحيحة وموجبة.");
                return;
            }
            const factors1 = getFactors(num1);
            const factors2 = getFactors(num2);
            const commonFactors = factors1.filter(f => factors2.includes(f));
            const resultList = document.getElementById('factors-list');
            resultList.innerHTML = '';
            commonFactors.forEach(factor => {
                const li = document.createElement('li');
                li.className = 'result-item';
                li.textContent = factor;
                resultList.appendChild(li);
            });
            document.getElementById('result-factors').style.display = 'block';
            const solutionDiv = document.getElementById('solution-factors');
            solutionDiv.innerHTML = `
                <h3>خطوات الحل:</h3>
                <ol>
                    <li>نوجد جميع عوامل العدد الأول (${num1}):
                        <p class="result-list rtl">${formatFactorsWithHighlight(factors1, commonFactors)}</p>
                    </li>
                    <li>نوجد جميع عوامل العدد الثاني (${num2}):
                        <p class="result-list rtl">${formatFactorsWithHighlight(factors2, commonFactors)}</p>
                    </li>
                    <li>العوامل المشتركة هي الأعداد التي تظهر في كلا القائمتين، وقد تم تمييزها بإطار أحمر.</li>
                </ol>
            `;
            solutionDiv.style.display = 'block';
        }

        function calculateGCF() {
            const num1 = parseInt(document.getElementById('num1-gcf').value);
            const num2 = parseInt(document.getElementById('num2-gcf').value);
            if (!num1 || !num2 || num1 < 1 || num2 < 1) {
                alert("الرجاء إدخال أعداد صحيحة وموجبة.");
                return;
            }
            const factors1 = getPrimeFactorsArray(num1);
            const factors2 = getPrimeFactorsArray(num2);
            const { html1, html2, commonFactors } = formatPrimeFactorsWithHighlight(factors1, factors2);
            let gcf = 1;
            commonFactors.forEach(f => gcf *= f);
            document.getElementById('gcf-value').innerHTML = `<span class="result-item">${gcf}</span>`;
            document.getElementById('result-gcf').style.display = 'block';
            const solutionDiv = document.getElementById('solution-gcf');
            solutionDiv.innerHTML = `
                <h3>خطوات الحل:</h3>
                <ol>
                    <li>نحلل العدد الأول (${num1}) إلى عوامله الأولية:
                        <p>${num1} = ${html1}</p>
                    </li>
                    <li>نحلل العدد الثاني (${num2}) إلى عوامله الأولية:
                        <p>${num2} = ${html2}</p>
                    </li>
                    <li>العامل المشترك الأعلى هو حاصل ضرب العوامل الأولية المشتركة فقط.
                       العوامل المشتركة هي التي تم تمييزها باللون الأحمر.</li>
                    <li>ع.م.أ = ${commonFactors.join(' × ')} = ${gcf}</li>
                </ol>
            `;
            solutionDiv.style.display = 'block';
        }

        function calculateMultiples() {
            const num1 = parseInt(document.getElementById('num1-multiples').value);
            const num2 = parseInt(document.getElementById('num2-multiples').value);
            if (!num1 || !num2 || num1 < 1 || num2 < 1) {
                alert("الرجاء إدخال أعداد صحيحة وموجبة.");
                return;
            }
            const factors1 = getPrimeFactorsArray(num1);
            const factors2 = getPrimeFactorsArray(num2);
            const { commonFactors, uncommonFactors } = formatPrimeFactorsWithHighlight(factors1, factors2);
            const allUniqueFactors = [...commonFactors, ...uncommonFactors];
            const lcmVal = allUniqueFactors.reduce((acc, curr) => acc * curr, 1);
            const multiplesList = document.getElementById('multiples-list');
            multiplesList.innerHTML = '';
            const maxMultiples = 10;
            const commonMultiples = [];
            for (let i = 1; i <= maxMultiples; i++) {
                const multiple = lcmVal * i;
                const li = document.createElement('li');
                li.className = 'result-item';
                li.textContent = multiple;
                multiplesList.appendChild(li);
                commonMultiples.push(multiple);
            }
            document.getElementById('result-multiples').style.display = 'block';
            const solutionDiv = document.getElementById('solution-multiples');
            solutionDiv.innerHTML = `
                <h3>خطوات الحل:</h3>
                <ol>
                    <li>أولاً، نوجد المضاعف المشترك الأصغر (م.م.أ) للعددين، وهو ${lcmVal}.</li>
                    <li>المضاعفات المشتركة الأخرى هي مضاعفات هذا العدد.</li>
                    <li>أول 10 مضاعفات مشتركة هي: ${commonMultiples.join(', ')}</li>
                </ol>
            `;
            solutionDiv.style.display = 'block';
        }

        function calculateLCM() {
            const num1 = parseInt(document.getElementById('num1-lcm').value);
            const num2 = parseInt(document.getElementById('num2-lcm').value);
            if (!num1 || !num2 || num1 < 1 || num2 < 1) {
                alert("الرجاء إدخال أعداد صحيحة وموجبة.");
                return;
            }
            const factors1 = getPrimeFactorsArray(num1);
            const factors2 = getPrimeFactorsArray(num2);
            const { html1, html2, commonFactors, uncommonFactors } = formatPrimeFactorsWithHighlight(factors1, factors2);
            const allUniqueFactors = [...commonFactors, ...uncommonFactors];
            const lcm = allUniqueFactors.reduce((acc, curr) => acc * curr, 1);
            document.getElementById('lcm-value').innerHTML = `<span class="result-item">${lcm}</span>`;
            document.getElementById('result-lcm').style.display = 'block';
            const solutionDiv = document.getElementById('solution-lcm');
            solutionDiv.innerHTML = `
                <h3>خطوات الحل:</h3>
                <ol>
                    <li>نحلل العدد الأول (${num1}) إلى عوامله الأولية:
                        <p>${num1} = ${html1}</p>
                    </li>
                    <li>نحلل العدد الثاني (${num2}) إلى عوامله الأولية:
                        <p>${num2} = ${html2}</p>
                    </li>
                    <li>المضاعف المشترك الأصغر هو حاصل ضرب جميع العوامل الأولية. نأخذ العوامل المشتركة مرة واحدة (المميزة باللون الأحمر) وجميع العوامل غير المشتركة (المميزة باللون الأزرق).</li>
                    <li>م.م.أ = ${allUniqueFactors.join(' × ')} = ${lcm}</li>
                </ol>
            `;
            solutionDiv.style.display = 'block';
        }

        // --- All Functions from Page 2 (Factor Tree) ---
        function isPrime(n) {
            if (n <= 1) return false;
            if (n <= 3) return true;
            if (n % 2 === 0 || n % 3 === 0) return false;
            for (let i = 5; i * i <= n; i = i + 6) {
                if (n % i === 0 || n % (i + 2) === 0) return false;
            }
            return true;
        }

        function findBalancedFactors(n) {
            const sqrt = Math.floor(Math.sqrt(n));
            for (let i = sqrt; i >= 2; i--) {
                if (n % i === 0) return [i, n / i];
            }
            return null;
        }

        function getColorForPrime(n) {
            const colors = {
                2: '#3498db', 3: '#e67e22', 5: '#16a085', 7: '#8e44ad', 11: '#c0392b',
                13: '#d35400', 17: '#27ae60', 19: '#f39c12', 23: '#e74c3c', 29: '#1abc9c', 31: '#2980b9'
            };
            return colors[n] || '#7f8c8d';
        }

        function buildFactorTree(n) {
            let levels = [[{ value: n, parentIndex: null, children: [] }]];
            let levelIndex = 0;
            while (true) {
                let currentLevel = levels[levelIndex];
                let nextLevel = [];
                let hasChanged = false;
                for (let i = 0; i < currentLevel.length; i++) {
                    const node = currentLevel[i];
                    if (isPrime(node.value) || node.value === 1) {
                        continue;
                    }
                    const factors = findBalancedFactors(node.value);
                    if (factors) {
                        factors.sort((a, b) => b - a);
                        const child1 = { value: factors[0], parentIndex: i, children: [] };
                        const child2 = { value: factors[1], parentIndex: i, children: [] };
                        nextLevel.push(child1, child2);
                        node.children = [nextLevel.length - 2, nextLevel.length - 1];
                        hasChanged = true;
                    }
                }
                if (!hasChanged) break;
                levels.push(nextLevel);
                levelIndex++;
            }
            return levels;
        }

        function renderTree(levels) {
            const treeDiv = document.getElementById('generatedTree');
            treeDiv.innerHTML = '';
            levels.forEach((level, levelIdx) => {
                const levelDiv = document.createElement('div');
                levelDiv.className = 'level';
                level.forEach(node => {
                    const nodeDiv = document.createElement('div');
                    nodeDiv.textContent = node.value;
                    nodeDiv.className = `node`;
                    nodeDiv.dataset.value = node.value;
                    if (isPrime(node.value)) {
                        nodeDiv.classList.add('circle', 'node-prime');
                        nodeDiv.style.backgroundColor = getColorForPrime(node.value);
                    } else {
                        nodeDiv.classList.add('box');
                    }
                    treeDiv.appendChild(levelDiv);
                    levelDiv.appendChild(nodeDiv);
                });
            });
            setTimeout(drawLines, 50);
        }

        function drawLines() {
            const svg = document.getElementById('svgLines');
            svg.innerHTML = '';
            const levels = document.querySelectorAll('#factor-tree-tab .level');
            if (levels.length <= 1) return;
            const treeContainerRect = document.getElementById('treeContainer').getBoundingClientRect();
            for (let i = 0; i < levels.length - 1; i++) {
                const parentNodes = Array.from(levels[i].querySelectorAll('.node'));
                const childNodes = Array.from(levels[i + 1].querySelectorAll('.node'));
                let childIndex = 0;
                parentNodes.forEach(parentNode => {
                    const parentValue = parseInt(parentNode.dataset.value);
                    if (isPrime(parentValue) || parentValue === 1) return;
                    const parentRect = parentNode.getBoundingClientRect();
                    for (let j = 0; j < 2; j++) {
                        if (childIndex < childNodes.length) {
                            const childNode = childNodes[childIndex];
                            const childRect = childNode.getBoundingClientRect();
                            const x1 = parentRect.left + parentRect.width / 2 - treeContainerRect.left;
                            const y1 = parentRect.bottom - treeContainerRect.top;
                            const x2 = childRect.left + childRect.width / 2 - treeContainerRect.left;
                            const y2 = childRect.top - treeContainerRect.top;
                            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                            line.setAttribute('x1', x1);
                            line.setAttribute('y1', y1);
                            line.setAttribute('x2', x2);
                            line.setAttribute('y2', y2);
                            line.setAttribute('stroke', 'var(--line-color)');
                            line.setAttribute('stroke-width', '2');
                            svg.appendChild(line);
                            childIndex++;
                        }
                    }
                });
            }
        }

        function showResults(num, levels) {
            const primeFactors = [];
            levels.forEach(level => {
                level.forEach(node => {
                    if (isPrime(node.value)) {
                        primeFactors.push(node.value);
                    }
                });
            });
            primeFactors.sort((a, b) => a - b);
            const productHtml = primeFactors.map(v => {
                const color = getColorForPrime(v);
                return `<span class="circle-inline" style="background:${color};">${v}</span>`;
            }).join(' × ');
            const exponentHtml = Object.entries(primeFactors.reduce((acc, val) => {
                acc[val] = (acc[val] || 0) + 1;
                return acc;
            }, {})).map(([base, exp]) => {
                return exp > 1 ? `${base}<sup>${exp}</sup>` : base;
            }).join(' × ');
            document.getElementById('result-display').innerHTML = `
                <div class="result-line">${num} = ${productHtml}</div>
                <div class="result-line">${num} = ${exponentHtml}</div>
            `;
        }

        function generateAndShowTree() {
            const num = parseInt(document.getElementById('numberInput').value);
            if (!num || num < 2) {
                alert('الرجاء إدخال عدد صحيح أكبر من 1.');
                return;
            }
            const levels = buildFactorTree(num);
            renderTree(levels);
            showResults(num, levels);
        }

        function saveAsImage() {
            const tree = document.getElementById('treeContainer');
            domtoimage.toPng(tree, {
                bgcolor: 'var(--bg-color)'
            }).then(function (dataUrl) {
                const link = document.createElement('a');
                link.download = `شجرة-عوامل-${document.getElementById('numberInput').value}.png`;
                link.href = dataUrl;
                link.click();
            }).catch(function (error) {
                console.error('خطأ في الحفظ كصورة!', error);
                alert('حدث خطأ أثناء حفظ الصورة.');
            });
        }

        // --- All Functions from Page 3 (Prime Numbers) ---
        // Renamed function to avoid conflict with `isPrime`
        function iP(n) {
            if (n <= 1) return false;
            if (n <= 3) return true;
            if (n % 2 === 0 || n % 3 === 0) return false;
            let s = Math.sqrt(n);
            for (let i = 5; i <= s; i += 6) {
                if (n % i === 0 || n % (i + 2) === 0) return false;
            }
            return true;
        }

        function cD(d) {
            switch (d) {
                case 1: return "#8B4513";
                case 3: return "green";
                case 7: return "orange";
                case 9: return "red";
                case 2: return "purple";
                case 5: return "blue";
                default: return "#555";
            }
        }

        function pS(p) {
            let c = cD(p % 10);
            return `<span class="prime" style="background:${c}">${p}</span>`;
        }

        function gP() {
            const n = +document.getElementById('n-prime').value;
            if (n <= 2) {
                document.getElementById('primesBox-prime').innerHTML = 'أدخل رقمًا أكبر من 2.';
                return;
            }
            const primes = [];
            for (let i = 2; i < n; i++) {
                if (iP(i)) {
                    primes.push(i);
                }
            }
            document.getElementById('primesBox-prime').innerHTML = primes.map(pS).join('');
        }

        function gPA() {
            const k = +document.getElementById('k-prime').value;
            if (k < 1) {
                document.getElementById('primeAtBox-prime').innerHTML = 'أدخل رقمًا موجبًا.';
                return;
            }
            let count = 0;
            let num = 1;
            while (count < k) {
                num++;
                if (iP(num)) {
                    count++;
                }
            }
            document.getElementById('primeAtBox-prime').innerHTML = `العدد الأولي رقم ${k} هو: ${pS(num)}`;
        }

        function cP() {
            const m = +document.getElementById('m-prime').value;
            const result = iP(m) ? 'عدد أولي' : 'ليس عددًا أوليًا';
            document.getElementById('checkBox-prime').innerHTML = `${pS(m)} : ${result}`;
        }

        function fSP() {
            const x = +document.getElementById('x-prime').value;
            if (x <= 2) {
                document.getElementById('surroundingBox-prime').innerHTML = 'أدخل رقمًا أكبر من 2.';
                return;
            }
            let lowerPrime = x - 1;
            let upperPrime = x + 1;
            while (lowerPrime > 1 && !iP(lowerPrime)) {
                lowerPrime--;
            }
            while (!iP(upperPrime)) {
                upperPrime++;
            }
            document.getElementById('surroundingBox-prime').innerHTML = `الأقرب: ${pS(lowerPrime)} ${pS(upperPrime)}`;
        }

        function fR() {
            const y = +document.getElementById('y-prime').value;
            if (y <= 1) {
                document.getElementById('rankBox-prime').innerHTML = 'أدخل رقمًا أكبر من 1.';
                return;
            }
            if (iP(y)) {
                let count = 0;
                for (let i = 2; i <= y; i++) {
                    if (iP(i)) count++;
                }
                document.getElementById('rankBox-prime').innerHTML = `${pS(y)}<br> هو العدد الأولي رقم ${count}`;
            } else {
                let lowerPrime = y - 1;
                let upperPrime = y + 1;
                while (lowerPrime > 1 && !iP(lowerPrime)) {
                    lowerPrime--;
                }
                while (!iP(upperPrime)) {
                    upperPrime++;
                }
                let lowerRank = 0;
                let upperRank = 0;
                let count = 0;
                for (let i = 2; i <= upperPrime; i++) {
                    if (iP(i)) {
                        count++;
                        if (i === lowerPrime) lowerRank = count;
                        if (i === upperPrime) upperRank = count;
                    }
                }
                document.getElementById('rankBox-prime').innerHTML = `${y} ليس أوليًا.<br><br>الأقرب:<br>${pS(lowerPrime)} رتبته ${lowerRank}<br>${pS(upperPrime)} رتبته ${upperRank}`;
            }
        }

        function fZ() {
            const z = +document.getElementById('z-prime').value;
            const factorsBox = document.getElementById('factorsBox-prime');
            if (z <= 1) {
                factorsBox.innerHTML = 'أدخل رقمًا أكبر من 1.';
                return;
            }
            let n = z;
            const factors = [];
            for (let i = 2; i <= n; i++) {
                while (n % i === 0) {
                    factors.push(i);
                    n /= i;
                }
            }
            factorsBox.innerHTML = `${z} = ` + factors.map(pS).join(' × ');
        }
    </script>
</body>
</html>
