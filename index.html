<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ ÙˆØ§Ù„Ù…Ø¶Ø§Ø¹ÙØ§Øª</title>

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <meta name="theme-color" content="#2c3e50">

    <style>
        /* General Styles & Root Variables */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c; /* Used for highlighting common items */
            --bg-color: #ecf0f1;
            --text-color: #34495e;
            --tab-bg: #bdc3c7;
            --tab-active-bg: #fff;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --border-color: #ccc;
            --line-color: #999;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Tahoma', sans-serif;
        }

        body {
            direction: rtl;
            background-color: #F0F8FF;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            width: 95%;
            max-width: 900px;
            margin: 20px auto;
            background: var(--tab-active-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            flex-grow: 1;
            padding: 10px;
        }

        .header {
            text-align: center;
            padding: 20px 0;
            background: var(--primary-color);
            color: #fff;
        }

        .header h1 {
            font-size: clamp(24px, 6vw, 32px);
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--primary-color);
        }

        .tab-button {
            flex: 1;
            text-align: center;
            padding: 15px 10px;
            cursor: pointer;
            font-size: clamp(14px, 3.5vw, 18px);
            font-weight: bold;
            color: var(--primary-color);
            background-color: var(--tab-bg);
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab-button.active {
            background-color: var(--tab-active-bg);
            color: var(--secondary-color);
            border-bottom: 2px solid var(--secondary-color);
        }

        .tab-content {
            padding: 20px;
            display: none;
            flex-direction: column;
            gap: 20px;
            animation: fadeIn 0.5s ease-in-out;
        }

        .tab-content.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-group, .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .input-group input, .controls input {
            width: 100%;
            max-width: 250px;
            padding: 10px;
            font-size: 16px;
            border: 1px solid var(--tab-bg);
            border-radius: 8px;
            text-align: center;
        }

        .input-group button, .controls button {
            width: 100%;
            max-width: 250px;
            padding: 12px;
            font-size: 18px;
            background-color: var(--secondary-color);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .input-group button:hover, .controls button:hover {
            background-color: #2980b9;
        }

        .result-box, .solution-box {
            background-color: var(--bg-color);
            padding: 15px;
            border-radius: 8px;
            border: 1px dashed var(--secondary-color);
        }

        .solution-box {
            border-color: var(--accent-color);
            margin-top: 10px;
        }

        .solution-box h3 {
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--accent-color);
        }

        .solution-box ol, .solution-box ul {
            list-style-position: inside;
            padding-right: 20px;
        }

        .solution-box li {
            margin-bottom: 5px;
            line-height: 1.5;
        }

        .result-box p {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 18px;
        }

        /* Styles for displaying lists of numbers (factors, multiples) */
        .result-list { /* This targets the UL for factors-list and multiples-list */
            list-style: none;
            display: flex;
            flex-direction: column; /* Stack multiple lists vertically */
            gap: 10px; /* Gap between list items */
            padding: 0;
        }

        .result-list-container { /* New class for wrapping factor items */
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
            justify-content: flex-start; /* Align to start */
        }

        .result-item { /* Style for individual number items */
            background-color: var(--secondary-color);
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: normal;
            display: inline-flex; /* Use flex for centering if needed */
            align-items: center;
            justify-content: center;
            min-width: 40px; /* Give a minimum width */
            text-align: center;
        }

        /* New CSS for factors highlighting */
        .factor-item {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            background-color: #fff;
            border: 1px solid var(--tab-bg);
            border-radius: 4px;
            color: var(--text-color);
        }

        .common-factor-box {
            border: 2px solid var(--accent-color);
            border-radius: 4px;
            animation: pulse-box 1.5s infinite;
        }

        @keyframes pulse-box {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .prime-factor {
            display: inline-block;
            font-weight: bold;
            padding: 4px 8px;
            margin: 0 4px;
            min-width: 25px;
            text-align: center;
            border-radius: 4px;
            color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .prime-factor:hover {
            transform: translateY(-2px);
        }

        .prime-factor.uncommon {
            background-color: #ccc !important;
            color: #000 !important;
        }

        /* Styles for Multiples Calculation */
        .multiples-group {
            margin-bottom: 15px;
            background-color: var(--bg-color);
            padding: 10px;
            border-radius: 8px;
            border: 1px dashed var(--tab-bg);
        }
        .multiples-group p {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 16px;
            color: var(--primary-color);
        }
        .multiples-display {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            direction: ltr; /* Ensure numbers are LTR */
            justify-content: flex-start; /* Align items to start */
        }
        .highlight-common-multiple {
            background-color: var(--accent-color) !important;
            color: #fff !important;
            animation: pulse-common-multiple 1.5s infinite;
        }

        @keyframes pulse-common-multiple {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }


        /* Styles for Page 2: Factor Tree */
        .tree-container {
            position: relative;
            display: inline-block;
            margin-top: 10px;
            min-height: 200px;
            width: 100%;
        }

        .svg-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .level {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 15px 0;
            position: relative;
            flex-wrap: wrap;
        }

        .node {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-color);
            border: 2px solid var(--text-color);
            font-weight: bold;
            position: relative;
            transition: transform 0.3s ease, background-color 0.3s ease;
            white-space: nowrap;
            padding: 8px 12px;
        }

        .box {
            border-radius: 8px;
        }

        .circle {
            border-radius: 50%;
            color: white;
            min-width: 40px;
            min-height: 40px;
        }

        .node-prime {
            animation: pulse 1.5s infinite;
        }

        #result-display {
            font-size: 18px;
            margin-top: 20px;
            color: #555;
            line-height: 1.8;
            direction: ltr;
        }

        .result-line {
            font-size: clamp(16px, 4vw, 22px);
            font-weight: bold;
            margin: 5px 0;
        }

        .circle-inline {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            color: #fff;
            font-weight: bold;
            text-align: center;
            margin: 0 4px;
        }

        /* Styles for Page 3: Prime Numbers - UPDATED */
        #prime-numbers-tab h2 {font-weight:bold; font-size:22px; margin-bottom:10px; background:#000; color:#fff; padding:10px; border-radius:8px; display:inline-block;}
        #prime-numbers-tab label {font-weight:bold; font-size:18px; display:block; margin:10px 0 5px; background:#ccc; color:#9370DB; border-radius:6px; padding:6px;}
        #prime-numbers-tab input[type=number] {width:80px; padding:5px; margin:5px; font-size:16px; font-weight:bold;}
        #prime-numbers-tab button {padding:8px 16px; margin:5px; font-size:16px; font-weight:bold; cursor:pointer; background-color: #4B0082; color: white; border: none; border-radius: 6px;}
        
        #prime-numbers-tab .primes-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px; /* Increased gap for more spacing */
            justify-content: center; /* Center align the grid itself */
            margin-top: 10px;
            direction: ltr;
            text-align: center; /* Center align text within the grid container */
        }
        #prime-numbers-tab .prime {
            padding: 8px 12px; /* Increased padding for larger boxes */
            border-radius: 6px; /* Slightly more rounded */
            display: inline-flex; /* Use inline-flex for centering content */
            align-items: center; /* Center vertically */
            justify-content: center; /* Center horizontally */
            color: white;
            font-size: 18px; /* Slightly larger font */
            min-width: 50px; /* Ensure minimum width for better spacing */
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* Add a subtle shadow */
            transition: transform 0.2s ease-in-out; /* Smooth hover effect */
        }
        #prime-numbers-tab .prime:hover {
            transform: translateY(-3px); /* Lift on hover */
        }

        #prime-numbers-tab #primesBox-prime,
        #prime-numbers-tab #primeAtBox-prime,
        #prime-numbers-tab #checkBox-prime,
        #prime-numbers-tab #surroundingBox-prime,
        #prime-numbers-tab #rankBox-prime,
        #prime-numbers-tab #factorsBox-prime {
            margin-top:10px;
            padding:10px;
            background-color:#e6e6fa;
            border: 2px solid #9370DB;
            border-radius:8px;
            word-wrap:break-word;
            font-size:18px;
            font-weight:bold;
            min-height:50px;
            direction:rtl;
            display:flex; /* Use flexbox for centering */
            align-items: center; /* Center vertically */
            justify-content: center; /* Center horizontally */
            flex-wrap: wrap; /* Allow content to wrap */
            text-align: center; /* Fallback for older browsers */
        }
        #prime-numbers-tab #factorsBox-prime .prime {
            /* Smaller style for factors within the factors box */
            padding: 4px 8px;
            font-size: 16px;
            min-width: unset; /* Remove min-width */
            margin: 0 4px; /* Adjust margin */
        }

        #install-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 12px 24px;
            font-size: 18px;
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: none; /* Hidden by default */
        }

        footer {
            text-align: center;
            padding: 15px;
            background: var(--primary-color);
            color: #fff;
            margin-top: 20px;
        }

        @media (max-width: 600px) {
            .tabs {
                flex-wrap: wrap;
            }
            .tab-button {
                flex: 50%;
                border-bottom: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”¢ Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ ÙˆØ§Ù„Ù…Ø¶Ø§Ø¹ÙØ§Øª</h1>
    </div>

    <div class="container">
        <div class="tabs">
            <div class="tab-button active" onclick="showTab('factors-multiples-tab')">Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ ÙˆØ§Ù„Ù…Ø¶Ø§Ø¹ÙØ§Øª</div>
            <div class="tab-button" onclick="showTab('factor-tree-tab')">Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹ÙˆØ§Ù…Ù„</div>
            <div class="tab-button" onclick="showTab('prime-numbers-tab')">Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©</div>
        </div>

        <div id="factors-multiples-tab" class="tab-content active">
            <h2>ğŸŒ¿ Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ ÙˆØ§Ù„Ù…Ø¶Ø§Ø¹ÙØ§Øª</h2>
            <div class="input-group">
                <input type="number" id="num1-factors" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„" min="1">
                <input type="number" id="num2-factors" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ" min="1">
                <button onclick="calculateFactors()">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©</button>
            </div>
            <div id="result-factors" class="result-box" style="display: none;">
                <p>Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©:</p>
                <ul id="factors-list" class="result-list"></ul>
            </div>
            <div id="solution-factors" class="solution-box" style="display: none;"></div>
            <hr>
            <div class="input-group">
                <input type="number" id="num1-gcf" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„" min="1">
                <input type="number" id="num2-gcf" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ" min="1">
                <button onclick="calculateGCF()">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø£Ø¹Ù„Ù‰</button>
            </div>
            <div id="result-gcf" class="result-box" style="display: none;">
                <p>Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø£Ø¹Ù„Ù‰ (Ø¹.Ù….Ø£):</p>
                <div id="gcf-value" class="result-list"></div>
            </div>
            <div id="solution-gcf" class="solution-box" style="display: none;"></div>
            <hr>
            <div class="input-group">
                <input type="number" id="num1-multiples" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„" min="1">
                <input type="number" id="num2-multiples" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ" min="1">
                <button onclick="calculateMultiples()">Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¶Ø§Ø¹ÙØ§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©</button>
            </div>
            <div id="result-multiples" class="result-box" style="display: none;">
                <p>Ø§Ù„Ù…Ø¶Ø§Ø¹ÙØ§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©:</p>
                <ul id="multiples-list" class="result-list"></ul>
            </div>
            <div id="solution-multiples" class="solution-box" style="display: none;"></div>
            <hr>
            <div class="input-group">
                <input type="number" id="num1-lcm" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„" min="1">
                <input type="number" id="num2-lcm" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ" min="1">
                <button onclick="calculateLCM()">Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¶Ø§Ø¹Ù Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø£ØµØºØ±</button>
            </div>
            <div id="result-lcm" class="result-box" style="display: none;">
                <p>Ø§Ù„Ù…Ø¶Ø§Ø¹Ù Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø£ØµØºØ± (Ù….Ù….Ø£):</p>
                <div id="lcm-value" class="result-list"></div>
            </div>
            <div id="solution-lcm" class="solution-box" style="display: none;"></div>
        </div>

        <div id="factor-tree-tab" class="tab-content">
            <h2 style="color: var(--primary-color);">ğŸŒ¿ Ø´Ø¬Ø±Ø© Ø§Ù„Ø¹ÙˆØ§Ù…Ù„</h2>
            <div class="controls">
                <input type="number" id="numberInput" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯Ù‹Ø§" min="2" />
                <button onclick="saveAsImage()">ğŸ“· Ø­ÙØ¸ ÙƒØµÙˆØ±Ø©</button>
                <button onclick="generateAndShowTree()">Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
            </div>
            <div class="tree-container" id="treeContainer">
                <svg class="svg-lines" id="svgLines"></svg>
                <div id="generatedTree"></div>
            </div>
            <div id="result-display"></div>
        </div>

        <div id="prime-numbers-tab" class="tab-content">
            <h2>ğŸ§® ØªÙˆÙ„ÙŠØ¯ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©</h2>
            <div>
              <label>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… n Ù„Ø¥ÙŠØ¬Ø§Ø¯ ÙƒÙ„ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ø§Ù„Ø£ØµØºØ± Ù…Ù†Ù‡:</label>
              <input type="number" id="n-prime" value="100">
              <button onclick="gP()">Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©</button>
              <div id="primesBox-prime" class="primes-grid"></div>
            </div>
            <hr>
            <div>
              <label>Ø£Ø¯Ø®Ù„ ØªØ±ØªÙŠØ¨ k Ù„Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ±ØªÙŠØ¨:</label>
              <input type="number" id="k-prime" value="10">
              <button onclick="gPA()">Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ</button>
              <div id="primeAtBox-prime"></div>
            </div>
            <hr>
            <div>
              <label>Ø§Ø®ØªØ¨Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ø¯Ø¯ m Ø£ÙˆÙ„ÙŠÙ‹Ø§:</label>
              <input type="number" id="m-prime" value="37">
              <button onclick="cP()">Ø§Ø®ØªØ¨Ø±</button>
              <div id="checkBox-prime"></div>
            </div>
            <hr>
            <div>
              <label>Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯Ø§ Ù„Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø¹Ø¯Ø¯ÙŠÙ† Ø§Ù„Ø£ÙˆÙ„ÙŠÙŠÙ† Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø§Ù„Ù…Ø­ØµÙˆØ± Ø¨ÙŠÙ†Ù‡Ù…Ø§:</label>
              <input type="number" id="x-prime" value="50">
              <button onclick="fSP()">Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø¯Ø¯ÙŠÙ†</button>
              <div id="surroundingBox-prime"></div>
            </div>
            <hr>
            <div>
              <label>Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯Ø§  Ù„Ø¥ÙŠØ¬Ø§Ø¯ Ø±ØªØ¨ØªÙ‡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£ÙˆÙ„ÙŠÙ‹Ø§ØŒ Ø£Ùˆ Ø§Ù„Ø¹Ø¯Ø¯ÙŠÙ† Ø§Ù„Ø£ÙˆÙ„ÙŠÙŠÙ† Ø§Ù„Ø£Ù‚Ø±Ø¨ ÙˆØ±ØªØ¨ØªÙ‡Ù…Ø§:</label>
              <input type="number" id="y-prime" value="20">
              <button onclick="fR()">Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø±ØªØ¨Ø©</button>
              <div id="rankBox-prime"></div>
            </div>
            <hr>
            <div>
              <label>Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯Ø§ Ù„ØªØ­Ù„ÙŠÙ„Ù‡ Ø¥Ù„Ù‰ Ø¹ÙˆØ§Ù…Ù„Ù‡ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©:</label>
              <input type="number" id="z-prime" value="120">
              <button onclick="fZ()">Ø­Ù„Ù„</button>
              <div id="factorsBox-prime" class="result-box"></div>
            </div>
        </div>
    </div>

    <button id="install-button">ğŸ“² ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>

    <footer>
        <marquee direction="right">
            Ù…Ø­Ù…ÙˆØ¯ Ø¹Ø§Ø¯Ù„ ØµØ§Ù„Ø­ - Ù…Ø¹Ù„Ù… Ø±ÙŠØ§Ø¶ÙŠØ§Øª
            <a href="https://www.facebook.com/share/1CUGAQAAh4/" target="_blank">
                <img class="fb-icon" src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" alt="Facebook" style="width: 18px; height: 18px; vertical-align: middle; margin: 0 4px;">
            </a>
        </marquee>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
    <script>
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù€ Service Worker Ù„ØªÙØ¹ÙŠÙ„ PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully: ', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed: ', error);
                    });
            });
        }

        let deferredPrompt;
        const installButton = document.getElementById('install-button');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.style.display = 'block';
        });

        installButton.addEventListener('click', () => {
            installButton.style.display = 'none';
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                } else {
                    console.log('User dismissed the install prompt');
                }
                deferredPrompt = null;
            });
        });

        // --- Tabs Logic ---
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.getElementById(tabId).style.display = 'flex';
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            showTab('factors-multiples-tab');
        });

        // --- All Functions from Page 1 (Factors and Multiples) ---
        function getFactors(num) {
            const factors = new Set();
            for (let i = 1; i <= Math.sqrt(num); i++) {
                if (num % i === 0) {
                    factors.add(i);
                    factors.add(num / i);
                }
            }
            return [...factors].sort((a, b) => a - b);
        }

        function getPrimeFactorsArray(num) {
            let n = num;
            const factors = [];
            for (let i = 2; i * i <= n; i++) {
                while (n % i === 0) {
                    factors.push(i);
                    n /= i;
                }
            }
            if (n > 1) {
                factors.push(n);
            }
            return factors;
        }

        const factorColors = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6', '#34495e', '#d35400', '#c0392b'];

        function getColoredPrimeFactors(factors1, factors2) {
            const factors1Copy = [...factors1];
            const factors2Copy = [...factors2];
            const result1 = [];
            const result2 = [];
            const commonFactors = [];
            let colorIndex = 0;

            for (let i = 0; i < factors1.length; i++) {
                const factor1 = factors1[i];
                const indexIn2 = factors2Copy.indexOf(factor1);
                if (indexIn2 > -1) {
                    const color = factorColors[colorIndex % factorColors.length];
                    result1.push(`<span class="prime-factor" style="background:${color};">${factor1}</span>`);
                    result2.push(`<span class="prime-factor" style="background:${color};">${factors2Copy[indexIn2]}</span>`);
                    commonFactors.push(factor1);
                    factors2Copy.splice(indexIn2, 1);
                    colorIndex++;
                } else {
                    result1.push(`<span class="prime-factor uncommon" style="background-color:#ccc; color:#000;">${factor1}</span>`);
                }
            }

            factors2Copy.forEach(factor2 => {
                result2.push(`<span class="prime-factor uncommon" style="background-color:#ccc; color:#000;">${factor2}</span>`);
            });

            return {
                html1: result1.join(' Ã— '),
                html2: result2.join(' Ã— '),
                commonFactors,
                allFactors: [...commonFactors, ...factors1.filter(f => !factors2.includes(f)), ...factors2.filter(f => !factors1.includes(f))]
            };
        }


        function formatFactorsWithHighlight(factors, commonFactors) {
            return `<div class="result-list-container rtl">${factors.map(f => {
                if (commonFactors.includes(f)) {
                    return `<span class="factor-item common-factor-box">${f}</span>`;
                }
                return `<span class="factor-item">${f}</span>`;
            }).join('')}</div>`;
        }

        function calculateFactors() {
            const num1 = parseInt(document.getElementById('num1-factors').value);
            const num2 = parseInt(document.getElementById('num2-factors').value);
            if (!num1 || !num2 || num1 < 1 || num2 < 1) {
                // Use a custom modal or message box instead of alert()
                // For simplicity, I'll use alert() here as per original code, but ideally replace this.
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø¹Ø¯Ø§Ø¯ ØµØ­ÙŠØ­Ø© ÙˆÙ…ÙˆØ¬Ø¨Ø©.");
                return;
            }
            const factors1 = getFactors(num1);
            const factors2 = getFactors(num2);
            const commonFactors = factors1.filter(f => factors2.includes(f));
            const resultList = document.getElementById('factors-list');
            resultList.innerHTML = '';
            commonFactors.forEach(factor => {
                const li = document.createElement('li');
                li.className = 'result-item';
                li.textContent = factor;
                resultList.appendChild(li);
            });
            document.getElementById('result-factors').style.display = 'block';
            const solutionDiv = document.getElementById('solution-factors');
            solutionDiv.innerHTML = `
                <h3>Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„:</h3>
                <ol>
                    <li>Ù†ÙˆØ¬Ø¯ Ø¬Ù…ÙŠØ¹ Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„ (${num1}):
                        ${formatFactorsWithHighlight(factors1, commonFactors)}
                    </li>
                    <li>Ù†ÙˆØ¬Ø¯ Ø¬Ù…ÙŠØ¹ Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ (${num2}):
                        ${formatFactorsWithHighlight(factors2, commonFactors)}
                    </li>
                    <li>Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ù‡ÙŠ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙŠ ØªØ¸Ù‡Ø± ÙÙŠ ÙƒÙ„Ø§ Ø§Ù„Ù‚Ø§Ø¦Ù…ØªÙŠÙ†ØŒ ÙˆÙ‚Ø¯ ØªÙ… ØªÙ…ÙŠÙŠØ²Ù‡Ø§ Ø¨Ø¥Ø·Ø§Ø± Ø£Ø­Ù…Ø±.</li>
                </ol>
            `;
            solutionDiv.style.display = 'block';
        }

        function calculateGCF() {
            const num1 = parseInt(document.getElementById('num1-gcf').value);
            const num2 = parseInt(document.getElementById('num2-gcf').value);
            if (!num1 || !num2 || num1 < 1 || num2 < 1) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø¹Ø¯Ø§Ø¯ ØµØ­ÙŠØ­Ø© ÙˆÙ…ÙˆØ¬Ø¨Ø©.");
                return;
            }
            const factors1 = getPrimeFactorsArray(num1);
            const factors2 = getPrimeFactorsArray(num2);
            const { html1, html2, commonFactors } = getColoredPrimeFactors(factors1, factors2);
            let gcf = 1;
            commonFactors.forEach(f => gcf *= f);
            document.getElementById('gcf-value').innerHTML = `<span class="result-item">${gcf}</span>`;
            document.getElementById('result-gcf').style.display = 'block';
            const solutionDiv = document.getElementById('solution-gcf');
            solutionDiv.innerHTML = `
                <h3>Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„:</h3>
                <ol>
                    <li>Ù†Ø­Ù„Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„ (${num1}) Ø¥Ù„Ù‰ Ø¹ÙˆØ§Ù…Ù„Ù‡ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©:
                        <p style="direction: ltr; text-align: left;">${num1} = ${html1}</p>
                    </li>
                    <li>Ù†Ø­Ù„Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ (${num2}) Ø¥Ù„Ù‰ Ø¹ÙˆØ§Ù…Ù„Ù‡ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©:
                        <p style="direction: ltr; text-align: left;">${num2} = ${html2}</p>
                    </li>
                    <li>Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù‡Ùˆ Ø­Ø§ØµÙ„ Ø¶Ø±Ø¨ Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© ÙÙ‚Ø· (Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø°Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ­Ø¯Ø©).</li>
                    <li>Ø¹.Ù….Ø£ = ${commonFactors.join(' Ã— ')} = ${gcf}</li>
                </ol>
            `;
            solutionDiv.style.display = 'block';
        }

        function calculateMultiples() {
            const num1 = parseInt(document.getElementById('num1-multiples').value);
            const num2 = parseInt(document.getElementById('num2-multiples').value);

            if (!num1 || !num2 || num1 < 1 || num2 < 1) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø¹Ø¯Ø§Ø¯ ØµØ­ÙŠØ­Ø© ÙˆÙ…ÙˆØ¬Ø¨Ø©.");
                return;
            }

            // 1. Generate first 7 multiples for each number
            const multiples1 = [];
            for (let i = 1; i <= 7; i++) {
                multiples1.push(num1 * i);
            }

            const multiples2 = [];
            for (let i = 1; i <= 7; i++) {
                multiples2.push(num2 * i);
            }

            // 2. Find common multiples from these first 7
            const commonMultiplesInitial = multiples1.filter(m => multiples2.includes(m));

            const resultList = document.getElementById('multiples-list');
            resultList.innerHTML = '';

            // Display first 7 multiples for num1
            const li1 = document.createElement('li');
            li1.className = 'multiples-group';
            li1.innerHTML = `<p>Ù…Ø¶Ø§Ø¹ÙØ§Øª ${num1} (Ø£ÙˆÙ„ 7):</p><div class="multiples-display">${multiples1.map(m => {
                return `<span class="result-item ${commonMultiplesInitial.includes(m) ? 'highlight-common-multiple' : ''}">${m}</span>`;
            }).join('')}</div>`;
            resultList.appendChild(li1);

            // Display first 7 multiples for num2
            const li2 = document.createElement('li');
            li2.className = 'multiples-group';
            li2.innerHTML = `<p>Ù…Ø¶Ø§Ø¹ÙØ§Øª ${num2} (Ø£ÙˆÙ„ 7):</p><div class="multiples-display">${multiples2.map(m => {
                return `<span class="result-item ${commonMultiplesInitial.includes(m) ? 'highlight-common-multiple' : ''}">${m}</span>`;
            }).join('')}</div>`;
            resultList.appendChild(li2);

            // 3. Calculate LCM to find additional common multiples
            const factors1 = getPrimeFactorsArray(num1);
            const factors2 = getPrimeFactorsArray(num2);
            const allFactorsForLCM = [];
            const tempFactors2ForLCM = [...factors2];

            for (const factor1 of factors1) {
                const index = tempFactors2ForLCM.indexOf(factor1);
                if (index > -1) {
                    allFactorsForLCM.push(factor1);
                    tempFactors2ForLCM.splice(index, 1);
                } else {
                    allFactorsForLCM.push(factor1);
                }
            }
            allFactorsForLCM.push(...tempFactors2ForLCM);
            const lcmVal = allFactorsForLCM.reduce((acc, curr) => acc * curr, 1);

            // 4. Generate at least 5 additional unique common multiples based on LCM
            const allCommonMultiplesSet = new Set(commonMultiplesInitial);
            const targetAdditionalCount = 5;
            let currentMultipleIndex = 1;

            // Loop to add more multiples until we have enough or hit a safeguard limit
            while (allCommonMultiplesSet.size < (commonMultiplesInitial.length + targetAdditionalCount)) {
                const nextMultiple = lcmVal * currentMultipleIndex;
                allCommonMultiplesSet.add(nextMultiple);
                currentMultipleIndex++;
                // Safeguard to prevent infinite loops for very large numbers or if LCM is 0/1
                if (currentMultipleIndex > 1000 && lcmVal > 0) break;
            }

            const allCommonMultiples = [...allCommonMultiplesSet].sort((a, b) => a - b);

            // Display all common multiples found
            const liCommon = document.createElement('li');
            liCommon.className = 'multiples-group';
            liCommon.innerHTML = `<p>Ø§Ù„Ù…Ø¶Ø§Ø¹ÙØ§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© (Ù…Ø¹ ØªÙ…ÙŠÙŠØ²Ù‡Ø§ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±):</p><div class="multiples-display">${allCommonMultiples.map(m => `<span class="result-item highlight-common-multiple">${m}</span>`).join('')}</div>`;
            resultList.appendChild(liCommon);

            document.getElementById('result-multiples').style.display = 'block';

            const solutionDiv = document.getElementById('solution-multiples');
            solutionDiv.innerHTML = `
                <h3>Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„:</h3>
                <ol>
                    <li>Ù†ÙˆØ¬Ø¯ Ø£ÙˆÙ„ 7 Ù…Ø¶Ø§Ø¹ÙØ§Øª Ù„Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„ (${num1}): ${multiples1.join(', ')}</li>
                    <li>Ù†ÙˆØ¬Ø¯ Ø£ÙˆÙ„ 7 Ù…Ø¶Ø§Ø¹ÙØ§Øª Ù„Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ (${num2}): ${multiples2.join(', ')}</li>
                    <li>Ù†Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¶Ø§Ø¹ÙØ§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ø¨ÙŠÙ† Ø§Ù„Ù‚Ø§Ø¦Ù…ØªÙŠÙ† (Ø§Ù„ØªÙŠ ØªÙ… ØªÙ…ÙŠÙŠØ²Ù‡Ø§ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø±).</li>
                    <li>Ø§Ù„Ù…Ø¶Ø§Ø¹Ù Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø£ØµØºØ± (Ù….Ù….Ø£) Ù„Ù„Ø¹Ø¯Ø¯ÙŠÙ† Ù‡Ùˆ ${lcmVal}.</li>
                    <li>Ù„Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø¶Ø§Ø¹ÙØ§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©ØŒ Ù†Ø¶Ø§Ø¹Ù Ø§Ù„Ù…Ø¶Ø§Ø¹Ù Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø£ØµØºØ±.</li>
                    <li>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¶Ø§Ø¹ÙØ§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ø§Ù„ØªÙŠ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡Ø§ Ù‡ÙŠ: ${allCommonMultiples.join(', ')}</li>
                </ol>
            `;
            solutionDiv.style.display = 'block';
        }

        function calculateLCM() {
            const num1 = parseInt(document.getElementById('num1-lcm').value);
            const num2 = parseInt(document.getElementById('num2-lcm').value);
            if (!num1 || !num2 || num1 < 1 || num2 < 1) {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø¹Ø¯Ø§Ø¯ ØµØ­ÙŠØ­Ø© ÙˆÙ…ÙˆØ¬Ø¨Ø©.");
                return;
            }
            const factors1 = getPrimeFactorsArray(num1);
            const factors2 = getPrimeFactorsArray(num2);
            const { html1, html2, commonFactors } = getColoredPrimeFactors(factors1, factors2);
            
            const allFactors = [];
            const tempFactors2 = [...factors2];

            for (const factor1 of factors1) {
                const index = tempFactors2.indexOf(factor1);
                if (index > -1) {
                    allFactors.push(factor1);
                    tempFactors2.splice(index, 1);
                } else {
                    allFactors.push(factor1);
                }
            }
            allFactors.push(...tempFactors2);

            const lcm = allFactors.reduce((acc, curr) => acc * curr, 1);
            
            document.getElementById('lcm-value').innerHTML = `<span class="result-item">${lcm}</span>`;
            document.getElementById('result-lcm').style.display = 'block';
            const solutionDiv = document.getElementById('solution-lcm');
            solutionDiv.innerHTML = `
                <h3>Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ù„:</h3>
                <ol>
                    <li>Ù†Ø­Ù„Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„ (${num1}) Ø¥Ù„Ù‰ Ø¹ÙˆØ§Ù…Ù„Ù‡ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©:
                        <p style="direction: ltr; text-align: left;">${num1} = ${html1}</p>
                    </li>
                    <li>Ù†Ø­Ù„Ù„ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ (${num2}) Ø¥Ù„Ù‰ Ø¹ÙˆØ§Ù…Ù„Ù‡ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©:
                        <p style="direction: ltr; text-align: left;">${num2} = ${html2}</p>
                    </li>
                    <li>Ø§Ù„Ù…Ø¶Ø§Ø¹Ù Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø§Ù„Ø£ØµØºØ± Ù‡Ùˆ Ø­Ø§ØµÙ„ Ø¶Ø±Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©. Ù†Ø£Ø®Ø° Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· (Ø°Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ­Ø¯Ø©)ØŒ Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹ÙˆØ§Ù…Ù„ ØºÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© (Ø°Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠØ©).</li>
                    <li>Ù….Ù….Ø£ = ${allFactors.join(' Ã— ')} = ${lcm}</li>
                </ol>
            `;
            solutionDiv.style.display = 'block';
        }

        // --- All Functions from Page 2 (Factor Tree) ---
        function isPrime(n) {
            if (n <= 1) return false;
            if (n <= 3) return true;
            if (n % 2 === 0 || n % 3 === 0) return false;
            for (let i = 5; i * i <= n; i = i + 6) {
                if (n % i === 0 || n % (i + 2) === 0) return false;
            }
            return true;
        }

        function findBalancedFactors(n) {
            const sqrt = Math.floor(Math.sqrt(n));
            for (let i = sqrt; i >= 2; i--) {
                if (n % i === 0) return [i, n / i];
            }
            return null;
        }

        function getColorForPrime(n) {
            const colors = {
                2: '#3498db', 3: '#e67e22', 5: '#16a085', 7: '#8e44ad', 11: '#c0392b',
                13: '#d35400', 17: '#27ae60', 19: '#f39c12', 23: '#e74c3c', 29: '#1abc9c', 31: '#2980b9'
            };
            return colors[n] || '#7f8c8d';
        }

        function buildFactorTree(n) {
            let levels = [[{ value: n, parentIndex: null, children: [] }]];
            let levelIndex = 0;
            while (true) {
                let currentLevel = levels[levelIndex];
                let nextLevel = [];
                let hasChanged = false;
                for (let i = 0; i < currentLevel.length; i++) {
                    const node = currentLevel[i];
                    if (isPrime(node.value) || node.value === 1) {
                        continue;
                    }
                    const factors = findBalancedFactors(node.value);
                    if (factors) {
                        factors.sort((a, b) => b - a);
                        const child1 = { value: factors[0], parentIndex: i, children: [] };
                        const child2 = { value: factors[1], parentIndex: i, children: [] };
                        nextLevel.push(child1, child2);
                        node.children = [nextLevel.length - 2, nextLevel.length - 1];
                        hasChanged = true;
                    }
                }
                if (!hasChanged) break;
                levels.push(nextLevel);
                levelIndex++;
            }
            return levels;
        }

        function renderTree(levels) {
            const treeDiv = document.getElementById('generatedTree');
            treeDiv.innerHTML = '';
            levels.forEach((level, levelIdx) => {
                const levelDiv = document.createElement('div');
                levelDiv.className = 'level';
                level.forEach(node => {
                    const nodeDiv = document.createElement('div');
                    nodeDiv.textContent = node.value;
                    nodeDiv.className = `node`;
                    nodeDiv.dataset.value = node.value;
                    if (isPrime(node.value)) {
                        nodeDiv.classList.add('circle', 'node-prime');
                        nodeDiv.style.backgroundColor = getColorForPrime(node.value);
                    } else {
                        nodeDiv.classList.add('box');
                    }
                    treeDiv.appendChild(levelDiv);
                    levelDiv.appendChild(nodeDiv);
                });
            });
            setTimeout(drawLines, 50);
        }

        function drawLines() {
            const svg = document.getElementById('svgLines');
            svg.innerHTML = '';
            const levels = document.querySelectorAll('#factor-tree-tab .level');
            if (levels.length <= 1) return;
            const treeContainerRect = document.getElementById('treeContainer').getBoundingClientRect();
            for (let i = 0; i < levels.length - 1; i++) {
                const parentNodes = Array.from(levels[i].querySelectorAll('.node'));
                const childNodes = Array.from(levels[i + 1].querySelectorAll('.node'));
                let childIndex = 0;
                parentNodes.forEach(parentNode => {
                    const parentValue = parseInt(parentNode.dataset.value);
                    if (isPrime(parentValue) || parentValue === 1) return;
                    const parentRect = parentNode.getBoundingClientRect();
                    for (let j = 0; j < 2; j++) {
                        if (childIndex < childNodes.length) {
                            const childNode = childNodes[childIndex];
                            const childRect = childNode.getBoundingClientRect();
                            const x1 = parentRect.left + parentRect.width / 2 - treeContainerRect.left;
                            const y1 = parentRect.bottom - treeContainerRect.top;
                            const x2 = childRect.left + childRect.width / 2 - treeContainerRect.left;
                            const y2 = childRect.top - treeContainerRect.top;
                            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                            line.setAttribute('x1', x1);
                            line.setAttribute('y1', y1);
                            line.setAttribute('x2', x2);
                            line.setAttribute('y2', y2);
                            line.setAttribute('stroke', 'var(--line-color)');
                            line.setAttribute('stroke-width', '2');
                            svg.appendChild(line);
                            childIndex++;
                        }
                    }
                });
            }
        }

        function showResults(num, levels) {
            const primeFactors = [];
            levels.forEach(level => {
                level.forEach(node => {
                    if (isPrime(node.value)) {
                        primeFactors.push(node.value);
                    }
                });
            });
            primeFactors.sort((a, b) => a - b);
            const productHtml = primeFactors.map(v => {
                const color = getColorForPrime(v);
                return `<span class="circle-inline" style="background:${color};">${v}</span>`;
            }).join(' Ã— ');
            const exponentHtml = Object.entries(primeFactors.reduce((acc, val) => {
                acc[val] = (acc[val] || 0) + 1;
                return acc;
            }, {})).map(([base, exp]) => {
                return exp > 1 ? `${base}<sup>${exp}</sup>` : base;
            }).join(' Ã— ');
            document.getElementById('result-display').innerHTML = `
                <div class="result-line">${num} = ${productHtml}</div>
                <div class="result-line">${num} = ${exponentHtml}</div>
            `;
        }

        function generateAndShowTree() {
            const num = parseInt(document.getElementById('numberInput').value);
            if (!num || num < 2) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ø£ÙƒØ¨Ø± Ù…Ù† 1.');
                return;
            }
            const levels = buildFactorTree(num);
            renderTree(levels);
            showResults(num, levels);
        }

        function saveAsImage() {
            const tree = document.getElementById('treeContainer');
            domtoimage.toPng(tree, {
                bgcolor: 'var(--bg-color)'
            }).then(function (dataUrl) {
                const link = document.createElement('a');
                link.download = `Ø´Ø¬Ø±Ø©-Ø¹ÙˆØ§Ù…Ù„-${document.getElementById('numberInput').value}.png`;
                link.href = dataUrl;
                link.click();
            }).catch(function (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸ ÙƒØµÙˆØ±Ø©!', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©.');
            });
        }

        // --- All Functions from Page 3 (Prime Numbers) ---
        function iP(n) {
            if (n <= 1) return false;
            if (n <= 3) return true;
            if (n % 2 === 0 || n % 3 === 0) return false;
            let s = Math.sqrt(n);
            for (let i = 5; i <= s; i += 6) {
                if (n % i === 0 || n % (i + 2) === 0) return false;
            }
            return true;
        }

        function cD(d) {
            switch (d) {
                case 1: return "#8B4513";
                case 3: return "green";
                case 7: return "orange";
                case 9: return "red";
                case 2: return "purple";
                case 5: return "blue";
                default: return "#555";
            }
        }

        function pS(p) {
            let c = cD(p % 10);
            return `<span class="prime" style="background:${c}">${p}</span>`;
        }

        function gP() {
            const n = +document.getElementById('n-prime').value;
            if (n <= 2) {
                document.getElementById('primesBox-prime').innerHTML = 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ù‹Ø§ Ø£ÙƒØ¨Ø± Ù…Ù† 2.';
                return;
            }
            const primes = [];
            for (let i = 2; i < n; i++) {
                if (iP(i)) {
                    primes.push(i);
                }
            }
            document.getElementById('primesBox-prime').innerHTML = primes.map(pS).join('');
        }

        function gPA() {
            const k = +document.getElementById('k-prime').value;
            if (k < 1) {
                document.getElementById('primeAtBox-prime').innerHTML = 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ù‹Ø§ Ù…ÙˆØ¬Ø¨Ù‹Ø§.';
                return;
            }
            let count = 0;
            let num = 1;
            while (count < k) {
                num++;
                if (iP(num)) {
                    count++;
                }
            }
            document.getElementById('primeAtBox-prime').innerHTML = `Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø±Ù‚Ù… ${k} Ù‡Ùˆ: ${pS(num)}`;
        }

        function cP() {
            const m = +document.getElementById('m-prime').value;
            const result = iP(m) ? 'Ø¹Ø¯Ø¯ Ø£ÙˆÙ„ÙŠ' : 'Ù„ÙŠØ³ Ø¹Ø¯Ø¯Ù‹Ø§ Ø£ÙˆÙ„ÙŠÙ‹Ø§';
            document.getElementById('checkBox-prime').innerHTML = `${pS(m)} : ${result}`;
        }

        function fSP() {
            const x = +document.getElementById('x-prime').value;
            if (x <= 2) {
                document.getElementById('surroundingBox-prime').innerHTML = 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ù‹Ø§ Ø£ÙƒØ¨Ø± Ù…Ù† 2.';
                return;
            }
            let lowerPrime = x - 1;
            let upperPrime = x + 1;
            while (lowerPrime > 1 && !iP(lowerPrime)) {
                lowerPrime--;
            }
            while (!iP(upperPrime)) {
                upperPrime++;
            }
            document.getElementById('surroundingBox-prime').innerHTML = `Ø§Ù„Ø£Ù‚Ø±Ø¨: ${pS(lowerPrime)} ${pS(upperPrime)}`;
        }

        function fR() {
            const y = +document.getElementById('y-prime').value;
            if (y <= 1) {
                document.getElementById('rankBox-prime').innerHTML = 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ù‹Ø§ Ø£ÙƒØ¨Ø± Ù…Ù† 1.';
                return;
            }
            if (iP(y)) {
                let count = 0;
                for (let i = 2; i <= y; i++) {
                    if (iP(i)) count++;
                }
                document.getElementById('rankBox-prime').innerHTML = `${pS(y)}<br> Ù‡Ùˆ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ø±Ù‚Ù… ${count}`;
            } else {
                let lowerPrime = y - 1;
                let upperPrime = y + 1;
                while (lowerPrime > 1 && !iP(lowerPrime)) {
                    lowerPrime--;
                }
                while (!iP(upperPrime)) {
                    upperPrime++;
                }
                let lowerRank = 0;
                let upperRank = 0;
                let count = 0;
                for (let i = 2; i <= upperPrime; i++) {
                    if (iP(i)) {
                        count++;
                        if (i === lowerPrime) lowerRank = count;
                        if (i === upperPrime) upperRank = count;
                    }
                }
                document.getElementById('rankBox-prime').innerHTML = `${y} Ù„ÙŠØ³ Ø£ÙˆÙ„ÙŠÙ‹Ø§.<br><br>Ø§Ù„Ø£Ù‚Ø±Ø¨:<br>${pS(lowerPrime)} Ø±ØªØ¨ØªÙ‡ ${lowerRank}<br>${pS(upperPrime)} Ø±ØªØ¨ØªÙ‡ ${upperRank}`;
            }
        }

        function fZ() {
            const z = +document.getElementById('z-prime').value;
            const factorsBox = document.getElementById('factorsBox-prime');
            if (z <= 1) {
                factorsBox.innerHTML = 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ù‹Ø§ Ø£ÙƒØ¨Ø± Ù…Ù† 1.';
                return;
            }
            let n = z;
            const factors = [];
            for (let i = 2; i <= n; i++) {
                while (n % i === 0) {
                    factors.push(i);
                    n /= i;
                }
            }
            factorsBox.innerHTML = `${z} = ` + factors.map(pS).join(' Ã— ');
        }
    </script>
</body>
</html>